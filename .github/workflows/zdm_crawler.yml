name: zdm_crawler

on:
  # 将下面两行代码取消注释
  schedule:
    - cron: "0/5 * * * *"
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
      with:
        token: ${{ secrets.PUSH_TOKEN }}
    - name: Configure Git
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
    - name: Set up JDK
      uses: actions/setup-java@v3
      with:
        java-version: '11'
        distribution: 'temurin'
        cache: maven
    - name: Build with Maven
      run: |
        mvn package
        cp ./target/zdm-0.0.1.jar ./zdm.jar
    - name: main logic
      env:
        # 爬取数据时的最大翻页数量
        maxPageSize: 20
        # 点值的数量>minVoted,才会被推送,填 0 为都推送
        minVoted: 10
        # 评论的数量>minComments,才会被推送,填 0 为都推送
        minComments: 10
        # 优惠信息数量>MIN_PUSH_SIZE 就会发邮件,否则积累到下一次触发任务再决定是否推送。不建议填太小的数字,避免邮件太多了
        MIN_PUSH_SIZE: 40
        # 邮箱的 smtp 服务器地址(示例给出的是 qq 邮箱的配置,非 qq 邮箱需要进行修改)
        emailHost: smtp.qq.com
        # 邮箱 smtp 服务端口
        emailPort: 465
        # 接收优惠信息的邮箱 为空代表不进行邮箱推送
        emailAccount: 599764916@qq.com
        # 接收优惠信息的邮箱的授权码 为空代表不进行邮箱推送
        emailPassword: fnkbdckmrmmhbbfe
        # WxPusher 极简推送模式的 spt 为空代表不进行 Wx 推送
        spt: ${{ secrets.spt }}
        # true:下载阶段打印出详细信息(待推送的优惠信息列表,过滤时使用的黑白词),因文本量比较大,在调通项目后可以改为 false
        detail: false
      run: java -jar zdm.jar
    # 保存已推送和暂未推送的优惠信息
    - name: git add files
      run: |
        git add .
    - name: git commit
      run: |
        git commit -m "update articles" || echo "No changes to commit"
    - name: git push
      run: |
        git push origin main
